---
title: "Точная нарезка материала"
permalink: /docs/pru/examples/material-cutter/
lang: ru
excerpt: "Выполняем нарезку материала в Hardella IDE"
modified: 2016-12-14T22:39:43+03:00
---

Эту задачу описали на [форуме owen.ru](http://www.owen.ru/forum/showthread.php?t=23600&page=9&p=222957&viewfull=1#post222957).

Процитирую:
1. На валу двигателя транспорта подачи материала установлен энкодер с разрешением 500 имп/об
1. Частота вращения двигателя - максимум 3000 об/мин (обычно 2000 об/мин)
1. Двигатель работает от частотника
1. Время, достаточное для подачи нужного количества материала ~0.4-0.6 сек за цикл
1. Энкодер подключен к счетчику, который управляет частотником двигателя
1. Двигатель низкоинерционный, остальная механика транспорта тоже. Останов происходит практически мгновенно, переезды есть, но они не критичны и их можно попытаться компенсировать программно.

От данного счетчика требуется отсчитать нужное количество импульсов и остановить двигатель. В следующем цикле счетчик должен быть обнулен до старта двигателя (переменная total в Вашем примере).

Т.е. счетчик должен уверенно и без пропусков считывать от одной фазы энкодера сигнал частотой до 30 кГц.

Если у вас открыта среда Hardella IDE, то можете либо
{% include ide_link addr="r:ce2450a8-9d37-4646-b206-51338109fd95/7014233255259703463" text="открыть код примера в среде" %}, либо создать свой проект на основе примера (`File` > `New` > `Project` > `Material cutter`).

## Решение

Создадим тип-перечисление для того, чтобы описывать текущее состояние системы (это делается правой кнопкой, `New` > `c.g.v.iec66131.types` > `type alias`):

<img width="360" alt="Enum для состояния" src="{{ "/assets/images/docs/pru/examples/material-cutter/state.png" | absolute_url }}">

Опишем нужную логику на языке ST:

<img width="946" alt="Логика нарезчика" src="{{ "/assets/images/docs/pru/examples/material-cutter/cutter-logic.png" | absolute_url }}">

Здесь более-менее прозрачно: выполняем то или иное действие в зависимости от текущего состояния.

Если движение закончено (текущее состояние `STOP`), то ждём пропадания `enable` для запуска нового движения.

В начальном состоянии `INIT` ждём когда установится нужная длина (`runLength`) и придёт сигнал на запуск (`enable`)

При движении считаем общий пробег в переменной `offset` и останавливаемся, если нужная длина пройдена.

<img width="658" alt="Программа для PRU" src="{{ "/assets/images/docs/pru/examples/material-cutter/program.png" | absolute_url }}">

В PRU программе всго 3 строки:
  1. В первой вызывается блок ABZ энкодера для вычисления его положения
  1. Во второй строке вызываем блок нарезчика. В качестве параметра `cntr` передаётся значение счётчика импульсов на 4-ом входе.
  1. Сигнал на включение мотора (`cutter.out`) выдаётся на 3-ый выход (`out3`).
